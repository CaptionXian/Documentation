# 数据测试网络组建报告
## 本报告包含内容
1. 概述
2. 数据前端产品已实现功能
3. 已实现智能合约
4. 已实现的后端系统服务
5. 近期产品优化规划
6. 测试报告摘要
7. 链在测试期间发现的问题与解决方案


## 概述
数据测试网络自8月初开始组建，整体实施基本符合预订的项目计划，具体工作包括：

1. 联盟成员服务器资源准备
2. 数链节点系统部署
3. 对数链节点多轮性能测试 
4. 钱包、交易所、区块浏览器等应用发布，其间发布了：
	* v1.0.0
	* v1.3.0
	* v1.3.1
	* v1.4.0:本周提测，将在9月7日发布，内容包括：匿踪查询功能完善、登录部分优化、视觉及用户体验优化等近30项修改
5. 后台数据服务系统服务发布，包括：github代码发布，各服务安装包发布，用户文档发布等
6. 富数数据应用上线及测试，当前线上的区块链行业数据合约已有正式对外应用。

到本周为止系统已初步具备数据交易服务能力。

## 数链前端产品已实现功能

1. 数据合约市场（包含数据合约产品分类展示，数据合约详情页，参与合约，双方相互签约等功能）
2. 充值中心（包含数积分，链积分充值和兑换功能）
3. 钱包账户（包含资产余额展示，转账，解锁，还款，提额，资源展示，资源购买，资源出售/赎回，近期活动，交易明细等功能）
4. 设置
    1. 账户列表（包含私钥查询，账号忽略，账号取消忽略，钱包账户李彪等功能
    2. 钱包管理（包含创建钱包，导入钱包，使用钱包，钱包密码修改，导入私钥，备份钱包，删除钱包等功能）
    3. 账户设置（包含商户认证，收款银行设置，联系人设置等功能)
    4. 服务地址（提供方服务地址设置）
5. 账号切换（同一个钱包内的多个账户可进行切换)
6. 用户中心
    1. 合约中心
     	* 创建的合约（包含合约查询，合约登记，修改功能）
     	* 参与的合约（包含参与合约的查询，退出合约，参与管理等功能）
     	* 创建合约
    2. 数据字典
     	* 数据字典管理（包含数据字典的创建，查询，修改，详情等功能）
     	* 我的数据字典（包含我的数据字典查询，修改，详情等功能）
    3. 订单中心
     	* 买家订单
     	* 卖家订单
    4. 供货中心
     	* 添加供货
     	* 供货管理（包含供货订单的上架，下架，修改功能）
7. 创建账户
8. 解锁

## 已实现的智能合约 
1. 数积分质押合约：用于web端将链积分质押为数积分进行数据交易等使用；
2. 认证合约：用于web端认证商家功能；
3. 交易所挂单合约：用于web端充值市场充值交易功能；
4. 数据字典合约：用于web端数据字典管理；
5. 数据合约：包括单次查询数据合约与批量查询数据合约，为后台系统数据模板合约；
6. ipfs存储合约：用于存储数据相关功能，暂时未应用。

## 已实现的后端系统服务
1. 数据桥接网关系统：
	* 用于读取企业内部数据，并将其转化为符合数据标准格式的数据，此系统可为让数据提供企业快速将数据接入数链。
2. 	数据输出服务：
	* 用来链接数据桥接网关、智能合约、sdk的核心服务；
	* 提供自定义数据模型处理的功能，用户可在web端上传自定义模式，模型将与合约绑定，并在此系统中自动执行；
	* 匿踪查询功能：用户保护查询人信息的一种服务。
3. 安全多方计算服务：
	* 当前实现了基于shamir秘密分享的安全多方计算模式，当前支持：sum、avg、count等操作。
4. 数据使用sdk
	* 用来访问数据上的数据。


## 近期产品优化规划 
1. 账号企业认证体系完善
    * 增加认证审核
    * 认证机制优化，采用分布式的认证机制，经过认证的机构也可以为其他新机构认证
2. 多方计算和模型计算优化
3. 充值中心和经济体制优化(采用bancor协议进行交易）
4. 创建合约流程优化（增加默认合约的方式，商户可快速上架合约）
5. 优化数据合约购买机制（调用合约所需的费用，采用手动购买机制）
6. 数据交易中心和钱包一些细节流程优化

## 测试报告摘要
##### 完整测试报告请查看另附件[测试报告](files/test_chain_test_report.pdf)
1. 链的测试摘要
	* 使用官方方法进行测试tps为：1000;
	* 使用数链数据合约进行测试tps为：110-130
	* 两者差异的主要原因为合约大小及处理逻辑，官方合约197K，数链合约为946K，数链合约包含更多逻辑，官方仅一个简单的转账操作
	* tps如何提高：后面主要将对合约进行优化，以提高性能
2. 后端服务性能
	* 安全多方计算性能：最大性能为800
	* 有部分后台服务测试工作仍在进行中
3. 功能测试
	* 我们已对整体系统的功能做了较完善测试，对发现的bug也做了管理了修改；
4. 当前可承受的业务量
	* 按120的tps
	* 10小时（对峰值和谷值进行平均）
	* 总的可承受访问量为：430万
	* 采用批量合约如每合约访问1000次，那么可以承受的业务量为：43亿

## 链在测试期间发现的问题与解决方案

#### 数链节点的相关参数
* 节点数：目前正常时，节点数是7个
* 部署系统版本：eos的nodeos版本使用的是v1.0.7版本
* 创世配置genesis.json：使用默认配置，未修改任何参数。
* 富数启动生产节点相关配置config.ini：当前使用的节点，同时提供了出块的功能和提供api的功能。

#### 数链节点在测试过程中发现的问题及解决方案
##### a. 502问题
* __描述__：在性能测试中，在线程数提高时，有不到0.5%的请求会报出502的错误。
* __原因__：api节点对外提供服务，是使用nginx域名映射代理访问后端节点的服务。查日志发现全是连接超时的错误。可能是性能测试时段时间高线程数频繁地访问服务，少数请求未及时响应超时。
* __解决方案__：增加提供api服务的节点数，降低单一api节点的压力；内部服务可以直接使用域名访问api节点。

##### b. 合约部署价格过高
* __描述__：在交易所创建一个系统合约需要花费约20的链积分。认为此价格过高。
* __原因__：这约20的链积分，其中绝大部分时用来购买ram。当前ram供应总量是64g，当前使用不足3个g，其实当前价格应是约0.018UCT/kB，合约需要940kB，就差不多17UCT了，这还是在ram价格几乎处于最低的时候。
* __解决方案__：大致有两个方案：1，减小合约文件大小；2，增加ram供应。如果希望降这个价格降到2UCT左右，只通过1达不到，通过2可以。将ram供应从默认的64g扩大到10倍可以立即使ram价格降下来，扩容的方法就是直接调用eosio系统合约setram方法。

##### c. 性能测试时，cpu价格暴涨
* __描述__：性能测试的时候，段时间内大量提交交易，导致cpu价格暴涨，并影响全网用户的cpu使用。
* __原因__：eos用户的cpu是根据全网的状态即时调整的，大致计算为：```个人cpu=个人权重/全网权重*全网可用cpu```，当存在大量交易的时候，全网可用cpu会持续下降，变相导致cpu价格暴涨。
* __解决方案__：查看源码之后，了解了全网可用cpu的计算机制。在链启动的时候会配置一个每一区块中cpu消耗的目标值(target), 当实际的1min内块平均cpu使用超过target时，可用cpu就会持续下降直至一个最小值。这个target可以根据我们的需求，在链启动的时候配置为一个合适的值。但是这个值在链启动之后，无法更改。这一现象是eos自身机制。

##### d. 压测时机器挂掉
* __描述__：在上周的第一次压测时，```youzu.111```的节点出现的问题，测试之后生产区块不正常，报出了```unlinkable block```。
* __原因__：暂未查明，后面测试未出现这一情况。
* __解决方案__：这个问题更一般可以理解为，生产节点如何保证节点正常工作，以及节点挂掉如何快速发现并处理。 可以利用区块浏览器对区块的生产情况进行监控，在一轮出块中，如果发现有节点未正常出块，即时地告警并处理。         

## 阶段性结果

链、前端产品、后端服务等已可满足前期业务需求，后续会对整体系体做更深入的增强与功能完善。我们认为当前实现水平已具备开始启动正式网络的条件，请大家审议整报告，如有疑问题请与我们联系。

感谢大家在过程中给予的配合与支持！！！
                                                                                                                                                                                                                     


